<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Trader AI Dashboard 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-main: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --neutral: #64748b;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Vazirmatn', sans-serif; }
        
        /* Gauge Meter Styles */
        .meter-container {
            width: 100%;
            height: 12px;
            background: #334155;
            border-radius: 6px;
            position: relative;
            margin-top: 10px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            width: 50%; /* Start at center */
            position: absolute;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .meter-marker {
            position: absolute;
            left: 50%;
            top: -2px;
            bottom: -2px;
            width: 2px;
            background: white;
            z-index: 10;
        }
        
        .card { background: var(--card-bg); border-radius: 1rem; border: 1px solid #334155; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .data-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid rgba(51, 65, 85, 0.5); font-size: 0.9rem; }
        .v-grid { display: grid; grid-template-columns: 340px 1fr; gap: 1.5rem; padding: 1rem; }
        @media (max-width: 1024px) { .v-grid { grid-template-columns: 1fr; } #chart-container { height: 450px; } }
        
        /* Loading Skeleton Animation */
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background: #334155; border-radius: 4px; color: transparent !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body>

<div class="v-grid min-h-screen">
    <div class="card p-5 h-fit">
        <div class="flex items-center justify-center gap-2 mb-6 border-b border-slate-700 pb-4">
            <span class="text-2xl">âš¡</span>
            <h2 class="text-xl font-extrabold text-blue-400">Pro Trader AI 2.0</h2>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-xs text-slate-400 mb-1 block">Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ</label>
                <select id="symbol" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white outline-none focus:border-blue-500" onchange="syncChartOnly()">
                    <option value="EUR/USD">EUR/USD</option>
                    <option value="GBP/USD">GBP/USD</option>
                    <option value="XAU/USD">XAU/USD (Gold)</option>
                    <option value="BTC/USD">BTC/USD (Crypto)</option>
                    <option value="ETH/USD">ETH/USD</option>
                </select>
            </div>
            <div>
                <label class="text-xs text-slate-400 mb-1 block">ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…</label>
                <select id="interval" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white outline-none focus:border-blue-500" onchange="syncChartOnly()">
                    <option value="5min">5 Min (Scalp)</option>
                    <option value="15min">15 Min (Day)</option>
                    <option value="1h" selected>1 Hour (Swing)</option>
                    <option value="4h">4 Hour (Macro)</option>
                </select>
            </div>
            <button onclick="runAnalysis()" id="btn-analyze" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition shadow-lg shadow-blue-900/20">
                Ø¢Ù†Ø§Ù„ÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§Ø²Ø§Ø± ğŸš€
            </button>
        </div>

        <div id="results" class="mt-6 hidden">
            
            <div id="signal-box" class="text-center p-4 rounded-xl font-black text-2xl mb-4 border-2">
                ---
            </div>

            <div class="mb-6">
                <div class="flex justify-between text-xs text-slate-400 mb-1">
                    <span>ÙØ±ÙˆØ´ Ù‚ÙˆÛŒ</span>
                    <span>Ø®Ù†Ø«ÛŒ</span>
                    <span>Ø®Ø±ÛŒØ¯ Ù‚ÙˆÛŒ</span>
                </div>
                <div class="meter-container">
                    <div class="meter-marker"></div>
                    <div id="score-fill" class="meter-fill bg-slate-500"></div>
                </div>
                <div class="text-center mt-1 text-xs font-mono text-yellow-400" id="score-text">Score: 0</div>
            </div>

            <div class="bg-slate-800/50 p-3 rounded-lg mb-4 border border-slate-700">
                <div class="text-xs text-slate-400 mb-2">ğŸ’ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… Ø¨Ø§Ù„Ø§ØªØ±</div>
                <div class="flex justify-between items-center">
                    <span class="text-sm" id="htf-name">---</span>
                    <span class="text-sm font-bold" id="htf-val">---</span>
                </div>
            </div>

            <div class="space-y-1">
                <div class="data-row"><span>Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</span> <span id="price-val" class="font-mono text-yellow-400">---</span></div>
                <div class="data-row"><span>Ø±ÙˆÙ†Ø¯ ÙØ¹Ù„ÛŒ</span> <span id="trend-val">---</span></div>
                <div class="data-row"><span>RSI (14)</span> <span id="rsi-val">---</span></div>
                <div class="data-row"><span>MACD Status</span> <span id="macd-val">---</span></div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-5">
                <div class="p-3 bg-slate-800/80 rounded-lg border border-green-500/30 text-center">
                    <div class="text-xs text-green-400 mb-1">TP (Ø­Ø¯ Ø³ÙˆØ¯)</div>
                    <div class="font-mono font-bold text-lg" id="tp-val">---</div>
                </div>
                <div class="p-3 bg-slate-800/80 rounded-lg border border-red-500/30 text-center">
                    <div class="text-xs text-red-400 mb-1">SL (Ø­Ø¯ Ø¶Ø±Ø±)</div>
                    <div class="font-mono font-bold text-lg" id="sl-val">---</div>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-container" class="card h-[85vh] overflow-hidden rounded-xl"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
    const intervalMap = { "5min": "5", "15min": "15", "1h": "60", "4h": "240" };
    
    window.onload = () => loadChart("EUR/USD", "1h");

    function syncChartOnly() {
        const s = document.getElementById("symbol").value;
        const i = document.getElementById("interval").value;
        loadChart(s, i);
    }

    function loadChart(symbol, intervalKey) {
        const tvSymbol = "FX_IDC:" + symbol.replace("/", ""); // Simple logic
        // Ø¨Ø±Ø§ÛŒ Ø·Ù„Ø§ Ùˆ Ú©Ø±ÛŒÙ¾ØªÙˆ Ø¨Ø§ÛŒØ¯ Ù‡Ù†Ø¯Ù„ Ø´ÙˆØ¯ Ú©Ù‡ Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø±Ø¯ÛŒÙ…
        
        new TradingView.widget({
            "autosize": true,
            "symbol": symbol.includes("BTC") ? "BINANCE:BTCUSDT" : (symbol.includes("XAU") ? "FX_IDC:XAUUSD" : tvSymbol),
            "interval": intervalMap[intervalKey],
            "timezone": "Asia/Tehran",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "container_id": "chart-container",
            "studies": ["RSI@tv-basicstudies", "MASimple@tv-basicstudies"]
        });
    }

    async function runAnalysis() {
        const btn = document.getElementById("btn-analyze");
        const results = document.getElementById("results");
        const symbol = document.getElementById("symbol").value;
        const interval = document.getElementById("interval").value;

        // UI Loading State
        btn.disabled = true;
        btn.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...";
        results.classList.remove("hidden");
        applySkeleton(true);

        try {
            const res = await fetch(`/analyze?symbol=${symbol}&interval=${interval}`);
            const data = await res.json();

            if(data.error) { alert("Error: " + JSON.stringify(data)); return; }
            
            renderData(data);
        } catch (e) {
            console.error(e);
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
        } finally {
            btn.disabled = false;
            btn.innerHTML = "Ø¢Ù†Ø§Ù„ÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§Ø²Ø§Ø± ğŸš€";
            applySkeleton(false);
        }
    }

    function renderData(data) {
        // 1. Signal Box
        const box = document.getElementById("signal-box");
        if(data.signal === "buy") {
            box.innerHTML = "ğŸŸ¢ BUY SIGNAL";
            box.className = "text-center p-4 rounded-xl font-black text-2xl mb-4 border-2 border-green-500 bg-green-500/20 text-green-400";
        } else if(data.signal === "sell") {
            box.innerHTML = "ğŸ”´ SELL SIGNAL";
            box.className = "text-center p-4 rounded-xl font-black text-2xl mb-4 border-2 border-red-500 bg-red-500/20 text-red-400";
        } else {
            box.innerHTML = "âšª NEUTRAL";
            box.className = "text-center p-4 rounded-xl font-black text-2xl mb-4 border-2 border-slate-500 bg-slate-500/20 text-slate-400";
        }

        // 2. Score Meter Logic
        const fill = document.getElementById("score-fill");
        const scoreText = document.getElementById("score-text");
        let widthPercentage = 50 + (data.score * 5); // ØªØ¨Ø¯ÛŒÙ„ Ø§Ù…ØªÛŒØ§Ø² -10 ØªØ§ +10 Ø¨Ù‡ 0 ØªØ§ 100 Ø¯Ø±ØµØ¯
        widthPercentage = Math.max(0, Math.min(100, widthPercentage)); // Clamp
        
        fill.style.width = widthPercentage + "%";
        fill.style.left = data.score < 0 ? widthPercentage + "%" : "50%";
        fill.style.width = Math.abs(widthPercentage - 50) + "%";
        
        // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
        fill.className = `meter-fill ${data.score > 0 ? 'bg-green-500' : (data.score < 0 ? 'bg-red-500' : 'bg-slate-500')}`;
        scoreText.innerText = `Score: ${data.score} / 10`;

        // 3. Data Filling
        document.getElementById("price-val").innerText = data.price;
        document.getElementById("trend-val").innerHTML = data.trend === "uptrend" 
            ? "<span class='text-green-400 font-bold'>ØµØ¹ÙˆØ¯ÛŒ â†—</span>" 
            : "<span class='text-red-400 font-bold'>Ù†Ø²ÙˆÙ„ÛŒ â†˜</span>";
            
        document.getElementById("rsi-val").innerText = data.indicators.rsi;
        document.getElementById("macd-val").innerText = data.indicators.macd;
        
        // 4. Multi Timeframe
        document.getElementById("htf-name").innerText = data.htf_status;
        document.getElementById("htf-val").innerHTML = data.htf_trend === "uptrend" 
            ? "<span class='text-green-400'>ØµØ¹ÙˆØ¯ÛŒ (Bullish)</span>" 
            : (data.htf_trend === "downtrend" ? "<span class='text-red-400'>Ù†Ø²ÙˆÙ„ÛŒ (Bearish)</span>" : "Ø®Ù†Ø«ÛŒ");

        // 5. Risk Management
        document.getElementById("tp-val").innerText = data.setup.tp || "-";
        document.getElementById("sl-val").innerText = data.setup.sl || "-";
    }

    function applySkeleton(isLoading) {
        const ids = ["price-val", "trend-val", "rsi-val", "tp-val", "sl-val", "htf-val"];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(isLoading) el.classList.add("skeleton");
            else el.classList.remove("skeleton");
        });
    }
</script>
</body>
</html>
