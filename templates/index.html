<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ØªØ­Ù„ÛŒÙ„ ÙØ§Ø±Ú©Ø³ (Pro Analyzer)</title>
    <!-- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Tailwind CSS Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ùˆ Ù…Ø¯Ø±Ù† -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --success: #10b981; /* Ø²Ù…Ø±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ */
            --danger: #ef4444; /* Ù‚Ø±Ù…Ø² Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ */
        }
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 1rem;
        }
        .v-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 1024px) {
            .v-grid { grid-template-columns: 1fr; }
            #chart-container { height: 400px !important; }
        }
        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .data-row {
            @apply flex justify-between items-center py-2 border-b border-slate-700/50 text-sm;
        }
        .data-row span:last-child {
            @apply font-bold text-base;
        }
        .signal-box {
            @apply text-xl font-extrabold p-4 rounded-xl text-center mb-4;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .buy-signal {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 2px solid var(--success);
        }
        .sell-signal {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        .neutral-signal {
            background: rgba(148, 163, 184, 0.15);
            color: var(--text-muted);
            border: 2px solid var(--text-muted);
        }
        .news-container {
            @apply mt-4 p-4 rounded-xl relative;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
        }
        .news-content {
             @apply text-sm font-medium leading-relaxed mt-2 whitespace-pre-line;
        }
        .translate-btn {
            @apply absolute top-3 left-3 bg-slate-800 text-xs text-slate-400 border border-slate-700 rounded-lg px-2 py-1 cursor-pointer hover:bg-slate-700;
        }
        .input-group label {
            @apply text-sm font-medium mb-1 text-slate-400;
        }
        .input-group select {
            @apply w-full p-3 bg-slate-800 border border-slate-700 text-white rounded-lg mb-4 text-base cursor-pointer;
        }
        #chart-container {
            @apply h-[70vh] rounded-xl overflow-hidden;
        }
    </style>
</head>
<body>

<div class="v-grid min-h-screen">
    <!-- Ø³ØªÙˆÙ† Ø³Ù…Øª Ø±Ø§Ø³Øª: Ù¾Ù†Ù„ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù†ØªØ§ÛŒØ¬ -->
    <div class="card p-5 h-full">
        <h2 class="text-xl font-extrabold mb-5 text-center text-accent border-b border-slate-700 pb-3">
            ğŸ‘¨â€ğŸ’» Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„â€ŒÚ¯Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
        </h2>
        
        <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ -->
        <div class="input-group">
            <label for="symbol">Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ</label>
            <select id="symbol" onchange="syncChartOnly()">
                <optgroup label="Majors">
                    <option value="EUR/USD" selected>EUR/USD</option>
                    <option value="GBP/USD">GBP/USD</option>
                    <option value="USD/JPY">USD/JPY</option>
                    <option value="XAU/USD">XAU/USD (Gold)</option>
                    <option value="BTC/USD">BTC/USD (Crypto)</option>
                </optgroup>
            </select>
        </div>
        
        <div class="input-group">
            <label for="interval">ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…</label>
            <select id="interval" onchange="syncChartOnly()">
                <option value="5min">5 Min</option>
                <option value="15min">15 Min</option>
                <option value="1h" selected>1 Hour</option>
                <option value="4h">4 Hour</option>
                <option value="1day">Daily</option>
            </select>
        </div>
        
        <button onclick="runAnalysis()" id="btn-analyze" class="w-full p-3 bg-accent text-white font-bold rounded-lg hover:bg-blue-600 transition duration-200">
            ğŸ“Š Ø¢Ù†Ø§Ù„ÛŒØ² Ø¨Ø§Ø²Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒØ¯Ù‡ÛŒ
        </button>

        <!-- Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ -->
        <div id="result-area" class="mt-6 pt-6 border-t border-slate-700/50 hidden">
            <div id="signal-banner" class="signal-box">---</div>

            <!-- Ù‚ÛŒÙ…Øª Ùˆ Ø±ÙˆÙ†Ø¯ -->
            <div class="data-row">
                <span>Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ:</span>
                <span class="data-val text-yellow-400" id="price-val">---</span>
            </div>
            <div class="data-row">
                <span>ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆÙ†Ø¯ (EMA):</span>
                <span class="data-val" id="trend-val">---</span>
            </div>
            <div class="data-row">
                <span>Ø§Ù„Ú¯ÙˆÛŒ Ú©Ù†Ø¯Ù„ÛŒ Ø§Ø®ÛŒØ±:</span>
                <span class="data-val" id="pattern-val">---</span>
            </div>
            <div class="data-row">
                <span>Ø§Ù…ØªÛŒØ§Ø² Ù‚Ø¯Ø±Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ (Score):</span>
                <span class="data-val" id="score-val">---</span>
            </div>

            <!-- Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ -->
            <div class="mt-5 p-3 bg-slate-800 rounded-lg">
                <div class="text-xs font-semibold text-slate-400 mb-2">Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§:</div>
                <div class="data-row border-none">
                    <span>RSI (Ø§Ø´Ø¨Ø§Ø¹):</span>
                    <span class="data-val" id="rsi-val">--</span>
                </div>
                <div class="data-row border-none">
                    <span>MACD (Ù…ÙˆÙ…Ù†ØªÙˆÙ…):</span>
                    <span class="data-val text-blue-400" id="macd-val">--</span>
                </div>
                <div class="data-row border-none">
                    <span>ATR (ÙØ±Ø§Ø±ÛŒØª):</span>
                    <span class="data-val" id="atr-val">--</span>
                </div>
                <div class="data-row border-none">
                    <span>Bollinger Bands:</span>
                    <span class="data-val text-pink-400" id="bb-pos-val">--</span>
                </div>
            </div>

            <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© -->
            <div class="grid grid-cols-2 gap-3 mt-5">
                <div class="p-3 bg-slate-800 rounded-lg text-center border border-success/50">
                    <span class="text-xs font-semibold text-success block">Ø­Ø¯ Ø³ÙˆØ¯ (TP - 2R)</span>
                    <span class="mini-val text-xl font-extrabold mt-1 block" id="tp-val" style="direction: ltr;">---</span>
                </div>
                <div class="p-3 bg-slate-800 rounded-lg text-center border border-danger/50">
                    <span class="text-xs font-semibold text-danger block">Ø­Ø¯ Ø¶Ø±Ø± (SL - 1R)</span>
                    <span class="mini-val text-xl font-extrabold mt-1 block" id="sl-val" style="direction: ltr;">---</span>
                </div>
            </div>
            
            <!-- ØªØ­Ù„ÛŒÙ„ Ø®Ø¨Ø±ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ -->
            <div class="news-container" id="news-box">
                <div class="text-sm font-extrabold text-accent">ğŸ“° Ø³Ù†ØªÛŒÙ…Ù†Øª Ø¨Ø§Ø²Ø§Ø± (ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ)</div>
                <button class="translate-btn" onclick="toggleTranslation()">EN / FA</button>
                <div class="news-content text-slate-200" id="news-text">---</div>
            </div>
        </div>
    </div>

    <!-- Ø³ØªÙˆÙ† Ø³Ù…Øª Ú†Ù¾: Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ±ÛŒØ¯ÛŒÙ†Ú¯ ÙˆÛŒÙˆ -->
    <div id="chart-container" class="card p-0"></div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
    let currentNews = { fa: "", en: "" };
    let isPersian = true;
    // Ù…Ù¾ÛŒÙ†Ú¯ ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…â€ŒÙ‡Ø§ÛŒ TwelveData Ø¨Ù‡ TradingView
    const intervalMap = { "5min": "5", "15min": "15", "1h": "60", "4h": "240", "1day": "1D" };
    const chartContainerId = "chart-container";

    window.onload = function() { loadChart("EUR/USD", "1h"); };

    function syncChartOnly() {
        const symbol = document.getElementById("symbol").value;
        const interval = document.getElementById("interval").value;
        loadChart(symbol, interval);
    }

    function loadChart(symbol, intervalKey) {
        document.getElementById(chartContainerId).innerHTML = "";
        
        let cleanSymbol = symbol.replace("/", "").replace("-", "");
        let tvSymbol = "FX_IDC:" + cleanSymbol; // Ù¾ÛŒØ´ ÙØ±Ø¶ ÙØ§Ø±Ú©Ø³
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ø®Ø§Øµ
        if (symbol.toLowerCase().includes("xau")) tvSymbol = "FX_IDC:XAUUSD";
        else if (symbol.toLowerCase().includes("btc")) tvSymbol = "BINANCE:BTCUSDT";

        let tvInterval = intervalMap[intervalKey] || "60";

        new TradingView.widget({
            "autosize": true,
            "symbol": tvSymbol,
            "interval": tvInterval,
            "timezone": "Asia/Tehran",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "container_id": chartContainerId,
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ù‡Ù… Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies", "BB@tv-basicstudies"],
            "overrides": {
                "paneProperties.background": "#0f172a",
                "paneProperties.vertGridProperties.color": "#2c313a",
                "paneProperties.horzGridProperties.color": "#2c313a",
                "symbolWatermarkProperties.color": "rgba(255, 255, 255, 0.08)",
                "mainSeriesProperties.candleStyle.upColor": "#10b981",
                "mainSeriesProperties.candleStyle.downColor": "#ef4444",
                "mainSeriesProperties.candleStyle.drawBorder": true,
                "mainSeriesProperties.candleStyle.borderUpColor": "#10b981",
                "mainSeriesProperties.candleStyle.borderDownColor": "#ef4444",
            }
        });
    }

    async function runAnalysis() {
        const symbol = document.getElementById("symbol").value;
        const interval = document.getElementById("interval").value;
        const btn = document.getElementById("btn-analyze");
        const resultArea = document.getElementById("result-area");

        btn.disabled = true; 
        btn.innerHTML = '<span class="animate-spin inline-block mr-2">âš™ï¸</span> Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';
        resultArea.classList.add("opacity-50");
        syncChartOnly();

        try {
            const response = await fetch(`/analyze?symbol=${encodeURIComponent(symbol)}&interval=${interval}`);
            const data = await response.json();

            if (data.error) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡: " + (data.details.message || JSON.stringify(data.details))); return; }

            displayResults(data);
            resultArea.classList.remove("hidden");

        } catch (e) { 
            console.error(e); 
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± ØªØ­Ù„ÛŒÙ„. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯."); 
        } 
        finally { 
            btn.disabled = false; 
            btn.innerText = "ğŸ“Š Ø¢Ù†Ø§Ù„ÛŒØ² Ø¨Ø§Ø²Ø§Ø± Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒØ¯Ù‡ÛŒ"; 
            resultArea.classList.remove("opacity-50");
        }
    }

    function displayResults(data) {
        const banner = document.getElementById("signal-banner");
        const trendText = data.trend === "uptrend" ? "ØµØ¹ÙˆØ¯ÛŒ (Bullish) ğŸŸ¢" : "Ù†Ø²ÙˆÙ„ÛŒ (Bearish) ğŸ”´";
        const trendColor = data.trend === "uptrend" ? "text-success" : "text-danger";

        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø§ØµÙ„ÛŒ
        document.getElementById("price-val").innerText = data.price;
        document.getElementById("trend-val").innerHTML = `<span class="${trendColor} font-bold">${trendText}</span>`;
        document.getElementById("pattern-val").innerText = data.pattern || "Ø§Ù„Ú¯ÙˆÛŒ Ø®Ø§ØµÛŒ Ù†ÛŒØ³Øª";
        
        // ØªÙ†Ø¸ÛŒÙ… Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ Ø±Ù†Ú¯
        const scoreElem = document.getElementById("score-val");
        scoreElem.innerText = data.score;
        scoreElem.classList.remove('text-success', 'text-danger', 'text-slate-400');
        if (data.score >= 5) scoreElem.classList.add('text-success');
        else if (data.score <= -5) scoreElem.classList.add('text-danger');
        else scoreElem.classList.add('text-slate-400');


        document.getElementById("tp-val").innerText = data.setup.tp || "---";
        document.getElementById("sl-val").innerText = data.setup.sl || "---";

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ÛŒ Ø¬Ø²Ø¦ÛŒ
        document.getElementById("rsi-val").innerText = data.indicators.rsi;
        document.getElementById("atr-val").innerText = data.indicators.atr;
        document.getElementById("macd-val").innerText = data.indicators.macd;
        document.getElementById("bb-pos-val").innerText = data.indicators.bb_pos === "Breakout" ? "Ø´Ú©Ø³Øª Ø¨Ø§Ù†Ø¯ âš ï¸" : "Ø¯Ø§Ø®Ù„ Ø¨Ø§Ù†Ø¯ (Inside)";

        // ØªÙ†Ø¸ÛŒÙ… Ø³Ù†ØªÛŒÙ…Ù†Øª Ùˆ Ø§Ø®Ø¨Ø§Ø±
        currentNews = data.indicators.sentiment;
        isPersian = true;
        document.getElementById("news-text").innerText = currentNews.fa;

        // ØªÙ†Ø¸ÛŒÙ… Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ
        banner.className = "signal-box";
        if (data.signal === "buy") { 
            banner.innerHTML = "Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù‚ÙˆÛŒ Ø®Ø±ÛŒØ¯ ğŸŸ¢ BUY"; 
            banner.classList.add("buy-signal"); 
        }
        else if (data.signal === "sell") { 
            banner.innerHTML = "Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù‚ÙˆÛŒ ÙØ±ÙˆØ´ ğŸ”´ SELL"; 
            banner.classList.add("sell-signal"); 
        }
        else { 
            banner.innerHTML = "Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ù†Ø«ÛŒ âšª NEUTRAL"; 
            banner.classList.add("neutral-signal"); 
        }
    }

    function toggleTranslation() {
        const newsTextElem = document.getElementById("news-text");
        if (!currentNews.en || !currentNews.fa) return;
        if (isPersian) { newsTextElem.innerText = currentNews.en; isPersian = false; }
        else { newsTextElem.innerText = currentNews.fa; isPersian = true; }
    }
</script>
</body>
</html>
